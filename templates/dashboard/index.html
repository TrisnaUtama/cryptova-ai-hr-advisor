{% extends "base_sidebar.html" %}
{% block title %}
  Admin Dashboard
{% endblock title %}
<!-- Dashboard Overview -->
{% block sidebar_content %}
  <style>
    .tab-btn.active {
      background-color: #fff !important;
      box-shadow: 0 2px 8px 0 rgba(37,99,235,0.08);
      font-weight: 600;
    }
    .tab-btn:hover:not(.active) {
      background-color: #e5e7eb;
      cursor: pointer;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
  <div class="dashboard-overview">
    <h1 class="text-2xl font-bold text-gray-900 mb-4">Admin Dashboard</h1>
    <p class="text-gray-500 mb-2">System Overview</p>
    <div class="flex space-x-2 mb-4">
      <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 active"
              data-tab="overview">Overview</button>
      <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700"
              data-tab="scoring">Scoring Weights</button>
      <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700"
              data-tab="candidates">Top Candidates</button>
    </div>
    <div id="tab-overview" class="tab-content active">
      <div class="grid grid-cols-4 gap-4 mb-6">
        {% include "./overview_card.html" with title="Total CVs" value="1,284" subtitle="+24 from yesterday" %}
        {% include "./overview_card.html" with title="Avg. Score" value="82.5" subtitle="+1.2 from last week" %}
        {% include "./overview_card.html" with title="High Scorers" value="87" subtitle="Score > 90" %}
        {% include "./overview_card.html" with title="Processing Rate" value="99.2%" subtitle="Successfully processed" %}
      </div>
      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="bg-white rounded-lg p-6 shadow">
          <h3 class="font-semibold mb-2">CV Processing</h3>
          <canvas id="cvProcessingChart" height="120"></canvas>
        </div>
        <div class="bg-white rounded-lg p-6 shadow">
          <h3 class="font-semibold mb-2">Average CV Score</h3>
          <canvas id="avgScoreChart" height="120"></canvas>
        </div>
      </div>
      <div class="bg-white rounded-lg p-6 shadow">
        <h3 class="font-semibold mb-2">CV Processing by Day</h3>
        <canvas id="cvByDayChart" height="120"></canvas>
      </div>
    </div>
    <div id="tab-scoring" class="tab-content">
      <div class="bg-white rounded-lg p-8 shadow mb-6">
        <h2 class="text-xl font-bold mb-6">Scoring Weights Configuration</h2>
        <div class="space-y-6">
          <div>
            <label class="block font-medium mb-1">
              Experience Weight: <span id="expWeightVal">30</span>%
            </label>
            <input id="expWeight"
                   type="range"
                   min="0"
                   max="100"
                   value="30"
                   class="w-full accent-blue-800">
          </div>
          <div>
            <label class="block font-medium mb-1">
              Skills Weight: <span id="skillsWeightVal">25</span>%
            </label>
            <input id="skillsWeight"
                   type="range"
                   min="0"
                   max="100"
                   value="25"
                   class="w-full accent-blue-800">
          </div>
          <div>
            <label class="block font-medium mb-1">
              Achievements Weight: <span id="achievementsWeightVal">15</span>%
            </label>
            <input id="achievementsWeight"
                   type="range"
                   min="0"
                   max="100"
                   value="15"
                   class="w-full accent-blue-800">
          </div>
          <div>
            <label class="block font-medium mb-1">
              Certificates Weight: <span id="certificatesWeightVal">10</span>%
            </label>
            <input id="certificatesWeight"
                   type="range"
                   min="0"
                   max="100"
                   value="10"
                   class="w-full accent-blue-800">
          </div>
          <div>
            <label class="block font-medium mb-1">
              GPA Weight: <span id="gpaWeightVal">20</span>%
            </label>
            <input id="gpaWeight"
                   type="range"
                   min="0"
                   max="100"
                   value="20"
                   class="w-full accent-blue-800">
          </div>
          <div class="flex justify-between items-center mt-2">
            <span class="text-gray-500 text-sm">Total: <span id="totalWeight">100</span>%</span>
            <button class="px-5 py-2 cursor-pointer bg-gray-900 text-gray-100 rounded-lg font-medium flex items-center gap-2 hover:bg-gray-200 hover:text-gray-900 transition">
              <i class="fa-solid fa-gear"></i>
              Apply & Re-score
            </button>
          </div>
        </div>
      </div>
      <div class="bg-blue-50 rounded-lg p-6 shadow">
        <h2 class="text-lg font-bold mb-2">Scoring Formula</h2>
        <pre class="bg-blue-50 text-gray-800 text-sm p-0 m-0 border-0 shadow-none">score = round(
  100 * (
    0.3 * min(years_exp / 15, 1.0) +
    0.25 * (matched_skills / 20) +
    0.15 * min(achievements / 10, 1.0) +
    0.1 * min(certificates / 5, 1.0) +
    0.2 * (gpa / 4.0)
  ),
  1
)</pre>
      </div>
      <script>
        // Slider value update
        const sliders = [
          { id: 'expWeight', val: 'expWeightVal' },
          { id: 'skillsWeight', val: 'skillsWeightVal' },
          { id: 'achievementsWeight', val: 'achievementsWeightVal' },
          { id: 'certificatesWeight', val: 'certificatesWeightVal' },
          { id: 'gpaWeight', val: 'gpaWeightVal' },
        ];
        function updateTotal() {
          let total = 0;
          sliders.forEach(s => {
            total += parseInt(document.getElementById(s.id).value);
          });
          document.getElementById('totalWeight').innerText = total;
        }
        sliders.forEach(s => {
          const slider = document.getElementById(s.id);
          const val = document.getElementById(s.val);
          slider.addEventListener('input', function() {
            val.innerText = this.value;
            updateTotal();
          });
        });
        updateTotal();
      </script>
    </div>
    <div id="tab-candidates" class="tab-content">
      <div class="bg-white rounded-lg p-8 shadow mb-6">
        <h2 class="text-xl font-bold mb-6">Top Scoring Candidates</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="border-b border-gray-200 text-gray-500 text-left">
                <th class="py-3 px-4 font-medium">Name</th>
                <th class="py-3 px-4 font-medium">Email</th>
                <th class="py-3 px-4 font-medium">Score</th>
                <th class="py-3 px-4 font-medium">Key Skills</th>
                <th class="py-3 px-4 font-medium text-center">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
              {% for candidate in top_candidates %}
                <tr>
                  <td class="py-3 px-4 font-medium text-gray-900">{{ candidate.name }}</td>
                  <td class="py-3 px-4 text-gray-700">{{ candidate.email }}</td>
                  <td class="py-3 px-4">
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium {% if candidate.score >= 90 %}bg-green-100 text-green-800 {% elif candidate.score >= 80 %}bg-blue-100 text-blue-800 {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                      {{ candidate.score }}
                    </span>
                  </td>
                  <td class="py-3 px-4 text-gray-700">{{ candidate.skills }}</td>
                  <td class="py-3 px-4 text-center">
                    <button class="p-1 rounded-full hover:bg-gray-100" title="View">
                      <svg class="w-5 h-5 text-gray-500"
                           fill="none"
                           stroke="currentColor"
                           viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                    </button>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="5" class="py-4 text-center text-gray-400">No candidates found.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="bg-white rounded-lg p-8 shadow">
        <h2 class="text-lg font-bold mb-4">Score Distribution</h2>
        <canvas id="scoreDistChart" height="180"></canvas>
      </div>
      <script>
        // Score Distribution Chart
        function renderScoreDistChart() {
          if (window.scoreDistChartInstance) {
            window.scoreDistChartInstance.destroy();
          }
          const ctx = document.getElementById('scoreDistChart');
          if (!ctx) return;
          window.scoreDistChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: ['90-100', '80-89', '70-79', '60-69', '50-59', '<50'],
              datasets: [{
                label: 'Candidates',
                data: [70, 140, 250, 190, 120, 80],
                backgroundColor: '#1e3a8a',
              }]
            },
            options: {
              responsive: true,
              plugins: { legend: { display: false } },
              scales: { y: { beginAtZero: true } }
            }
          });
        }
        document.querySelector('[data-tab="candidates"]').addEventListener('click', renderScoreDistChart);
        if (document.getElementById('tab-candidates').classList.contains('active')) {
          renderScoreDistChart();
        }
      </script>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Tab button functionality
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => {
          b.classList.remove('active', 'bg-white', 'shadow-md');
          b.classList.add('bg-gray-100', 'text-gray-700');
        });
        this.classList.add('active', 'bg-white', 'shadow-md');
        this.classList.remove('bg-gray-100', 'text-gray-700');
        // Tab content
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        document.getElementById('tab-' + this.dataset.tab).classList.add('active');
      });
    });

    // Chart.js hanya akan diinisialisasi jika Overview tab aktif (default)
    if (document.getElementById('tab-overview').classList.contains('active')) {
      new Chart(document.getElementById("cvProcessingChart"), {
        type: "line",
        data: {
          labels: ["05/05", "05/06", "05/07", "05/08", "05/09", "05/10", "05/11"],
          datasets: [
            {
              label: "Uploaded",
              data: [15, 22, 21, 27, 19, 17, 14],
              borderColor: "#2563eb",
              backgroundColor: "rgba(37,99,235,0.1)",
              tension: 0.4,
            },
            {
              label: "Processed",
              data: [14, 21, 20, 25, 18, 16, 13],
              borderColor: "#fbbf24",
              backgroundColor: "rgba(251,191,36,0.1)",
              tension: 0.4,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: { y: { beginAtZero: true } },
        },
      });

      new Chart(document.getElementById("avgScoreChart"), {
        type: "line",
        data: {
          labels: ["05/05", "05/06", "05/07", "05/08", "05/09", "05/10", "05/11"],
          datasets: [
            {
              label: "Score",
              data: [82, 80, 81, 85, 83, 84, 82],
              borderColor: "#2563eb",
              backgroundColor: "rgba(37,99,235,0.1)",
              tension: 0.4,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { min: 60, max: 100 } },
        },
      });

      new Chart(document.getElementById("cvByDayChart"), {
        type: "bar",
        data: {
          labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
          datasets: [
            {
              label: "Uploads",
              data: [45, 50, 38, 65, 47, 10, 8],
              backgroundColor: "#2563eb",
            },
            {
              label: "Parsed",
              data: [44, 49, 37, 63, 46, 9, 7],
              backgroundColor: "#fbbf24",
            },
          ],
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: { y: { beginAtZero: true } },
        },
      });
    }
  </script>
{% endblock sidebar_content %}
