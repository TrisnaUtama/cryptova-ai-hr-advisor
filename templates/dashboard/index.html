{% extends "base_sidebar.html" %}
{% block title %}
  Admin Dashboard
{% endblock title %}
<!-- Dashboard Overview -->
{% block sidebar_content %}
  <style>
    .tab-btn.active {
      background-color: #fff !important;
      box-shadow: 0 2px 8px 0 rgba(37,99,235,0.08);
      font-weight: 600;
    }
    .tab-btn:hover:not(.active) {
      background-color: #e5e7eb;
      cursor: pointer;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
  <div class="dashboard-overview">
    <h1 class="text-2xl font-bold text-gray-900 mb-4">Admin Dashboard</h1>
    <p class="text-gray-500 mb-2">System Overview</p>
    <div class="flex space-x-2 mb-4">
      <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700 active"
              data-tab="overview">Overview</button>
      <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700"
              data-tab="scoring">Scoring Weights</button>
      <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-gray-100 text-gray-700"
              data-tab="candidates">Top Candidates</button>
    </div>
    <!-- Overview Tab -->
    {% include "./overview_tab.html" %}
    <!-- Scoring Weights Tab -->
    {% include "./scoring_tab.html" %}
    <!-- Top Candidates Tab -->
    {% include "./top_candidates_tab.html" %}
  </div>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Tab button functionality
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        document.querySelectorAll('.tab-btn').forEach(b => {
          b.classList.remove('active', 'bg-white', 'shadow-md');
          b.classList.add('bg-gray-100', 'text-gray-700');
        });
        this.classList.add('active', 'bg-white', 'shadow-md');
        this.classList.remove('bg-gray-100', 'text-gray-700');
        // Tab content
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        document.getElementById('tab-' + this.dataset.tab).classList.add('active');
      });
    });

    // Initialize the first tab
    if (document.getElementById('tab-overview').classList.contains('active')) {
      // CV processing chart
      new Chart(document.getElementById("cvProcessingChart"), {
        type: "line",
        data: {
          labels: ["05/05", "05/06", "05/07", "05/08", "05/09", "05/10", "05/11"],
          datasets: [
            {
              label: "Uploaded",
              data: {{ uploaded_cvs }},
              borderColor: "#2563eb",
              backgroundColor: "rgba(37,99,235,0.1)",
              tension: 0.4,
            },
            {
              label: "Processed",
              data: {{processed_cvs}},
              borderColor: "#fbbf24",
              backgroundColor: "rgba(251,191,36,0.1)",
              tension: 0.4,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: { y: { beginAtZero: true } },
        },
      });

      // Average score chart
      new Chart(document.getElementById("avgScoreChart"), {
        type: "line",
        data: {
          labels: ["05/05", "05/06", "05/07", "05/08", "05/09", "05/10", "05/11"],
          datasets: [
            {
              label: "Score",
              data: {{ avg_scores }},
              borderColor: "#2563eb",
              backgroundColor: "rgba(37,99,235,0.1)",
              tension: 0.4,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { min: 60, max: 100 } },
        },
      });

      // CVs processing report by day chart
      new Chart(document.getElementById("cvByDayChart"), {
        type: "bar",
        data: {
          labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
          datasets: [
            {
              label: "Uploads",
              data: {{uploaded_cvs_per_day}},
              backgroundColor: "#2563eb",
            },
            {
              label: "Parsed",
              data: {{parsed_cvs_per_day}},
              backgroundColor: "#fbbf24",
            },
          ],
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: { y: { beginAtZero: true } },
        },
      });
    }

    // Slider value update
    const sliders = [
      { id: 'expWeight', val: 'expWeightVal' },
      { id: 'skillsWeight', val: 'skillsWeightVal' },
      { id: 'achievementsWeight', val: 'achievementsWeightVal' },
      { id: 'certificatesWeight', val: 'certificatesWeightVal' },
      { id: 'gpaWeight', val: 'gpaWeightVal' },
    ];
    function updateTotal() {
      let total = 0;
      sliders.forEach(s => {
        total += parseInt(document.getElementById(s.id).value);
      });
      document.getElementById('totalWeight').innerText = total;
    }
    sliders.forEach(s => {
      const slider = document.getElementById(s.id);
      const val = document.getElementById(s.val);
      slider.addEventListener('input', function() {
        val.innerText = this.value;
        updateTotal();
      });
    });
    updateTotal();

    // Score Distribution Chart
    function renderScoreDistChart() {
      if (window.scoreDistChartInstance) {
        window.scoreDistChartInstance.destroy();
      }
      const ctx = document.getElementById('scoreDistChart');
      if (!ctx) return;
      window.scoreDistChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['90-100', '80-89', '70-79', '60-69', '50-59', '<50'],
          datasets: [{
            label: 'Candidates',
            data: {{ score_distribution }},
            backgroundColor: '#1e3a8a',
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }
    document.querySelector('[data-tab="candidates"]').addEventListener('click', renderScoreDistChart);
    if (document.getElementById('tab-candidates').classList.contains('active')) {
      renderScoreDistChart();
    }
  </script>
{% endblock sidebar_content %}
